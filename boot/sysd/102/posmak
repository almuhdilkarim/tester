
function raptor_boots_post_prep() {

    if [[ -e /mnt/boot/amd-ucode.img ]]; then
        echo "clean microcode"
        mv /mnt/boot/amd-ucode.img /mnt/boot/kernel/ 
    fi

    if [[ -e /mnt/boot/intel-ucode.img ]]; then
        echo "clean microcode"
        mv /mnt/boot/intel-ucode.img /mnt/boot/kernel/ 
    fi

    if [[ -e /mnt/boot/vmlinuz-linux ]]; then
        echo "clean vmlinuz"
        kernel_type="vmlinuz-linux"
        mv /mnt/boot/vmlinuz-linux  /mnt/boot/kernel/ 
    fi

    if [[ -e /mnt/boot/vmlinuz-linux-zen ]]; then
        echo "clean vmlinuz"
        kernel_type="vmlinuz-linux-zen"
        mv /mnt/boot/vmlinuz-linux-zen  /mnt/boot/kernel/ 
    fi

    if [[ -e /mnt/boot/vmlinuz-linux-hardened ]]; then
        echo "clean vmlinuz"
        kernel_type="vmlinuz-linux-hardened"
        mv /mnt/boot/vmlinuz-linux-hardened  /mnt/boot/kernel/ 
    fi

    if [[ -e /mnt/boot/vmlinuz-linux-lqx ]]; then
        echo "clean vmlinuz"
        kernel_type="vmlinuz-linux-lqx"
        mv /mnt/boot/vmlinuz-linux-lqx  /mnt/boot/kernel/ 
    fi

    if [[ -e /mnt/boot/vmlinuz-linux-lts ]]; then
        echo "clean vmlinuz"
        kernel_type="vmlinuz-linux-lts"
        mv /mnt/boot/vmlinuz-linux-lts  /mnt/boot/kernel/ 
    fi

    test -e /mnt/boot/initramfs* && rm -f /mnt/boot/initramfs*
    echo "clean initramfs" && sleep 1
}

function raptor_boots_post_boot() {

    source /mnt/usr/lib/os-release 
    echo "root=$procpath" > /mnt/etc/cmdline.d/01-boot.conf && 

    if [[ -n $uefipath ]];then
        arch-chroot /mnt sbctl create-keys &&
        arch-chroot /mnt sbctl enroll-keys -m -i
        arch-chroot /mnt sbctl verify | sed -E 's|^.* (/.+) is not signed$| arch-chroot /mnt sbctl sign -s "\1"|e' &&
        sleep 1 && echo "enroll oem boot keys" 
    else
        arch-chroot /mnt sbctl create-keys &&
        arch-chroot /mnt sbctl enroll-keys -f
        sleep 1 && echo "enroll device boot keys"
    fi

    arch-chroot /mnt sbctl sign -s -o /usr/lib/systemd/boot/efi/systemd-bootx64.efi.signed /usr/lib/systemd/boot/efi/systemd-bootx64.efi &&
    bootctl --path=/mnt/boot/ --efi-boot-option-description=$ID install &&
    echo "installation systemd boot" &&  sleep 2
}

function raptor_boots_post_srvc() {
    arch-chroot /mnt systemctl enable systemd-boot-update.service
    echo "enable boot service" && sleep 1
}

function raptor_boots_post() {
    sleep 2 && clear
    echo "Booting module configuration"
    raptor_boots_post_prep &&
    raptor_boots_post_boot && 
    raptor_boots_post_srvc
}